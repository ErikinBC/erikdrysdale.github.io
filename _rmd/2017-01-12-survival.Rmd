---
title: 'DRAFT: Introduction to survival analysis'
output: html_document
fontsize: 12pt
published: false
status: process
mathjax: true
---

```{r,echo=F,message=FALSE,warning=FALSE,results='hide'}
# Call in the CRAN packages
ll <- c('tidyverse','magrittr','cowplot','scales','ggrepel','GGally')
        # 'survival','smcure','survminer')
sapply(ll,function(l) require(l,character.only = T))
```

## Introduction

Understanding the dynamics of survival times in clinical settings is important to both medical practitioners and patients. In statistics, time-to-event (or duration) analysis models a continuous random variable $T$, which represents the the length of a state. If the state is being alive, then the time to event is mortality, and we refer to it as [survival anaylsis](https://en.wikipedia.org/wiki/Survival_analysis). If $t$ is a given realization of $T$, then we are conceptually interested in modelling $P_\theta(T>t\|X)$, indexed by some parametric distribution $\theta$ and conditional of some baseline covariates $X$. If a patient has a "state" of some form of cancer, then survival analysis answers the question: what is the probability that life expectancy will exceed $t$ months given your baseline features $X$ (age, gender, genotype, etc) and underlying biological dynamics $\theta$[[^1]].

If $T$ is a continuous random variable, then it has a CDF and PDF of course, but in survival analysis we are also interested in two other functions (dropping the subscripts/conditional variables for notational simplicity):

1. **Survivor function**: $S(t)=1-F(t)$. Probability of being alive at time $t$. 
2. **Hazard function**: $h(t)=\frac{f(t)}{S(t)}$. The rate of change of risk, given you are alive at $t$.

Visualizing each function in `R` provides a useful way to understand what each function tells us. Assume that $T \sim \text{Exp}(\theta)$ distribution.

```{r surv1,echo=T,fig.height=3.5,fig.width=3.5}
# Use theta=2
F.t <- function(t) { pexp(t,rate=2) }
f.t <- function(t) { dexp(t,rate=2) }
S.t <- function(t) { 1 - F.t(t) }
h.t <- function(t) { f.t(t)/S.t(t) }
# Generate data
dat1 <- data.frame(t=seq(0,2,0.1)) %>%
          mutate(Ft=F.t(t),ft=f.t(t),St=S.t(t),ht=h.t(t)) %>%
          gather(dist,val,-t) %>% tbl_df %>% mutate(dist=gsub('t','[t]',dist))
# Plot
ggplot(dat1,aes(x=t,y=val,color=dist)) + geom_line(size=2,show.legend=F) +
  facet_wrap(~dist,scales='free_y',labeller=label_parsed) + theme_cowplot(font_size = 12) +
  labs(x='Time') + ggtitle('Survival analysis functions') + theme(axis.title.y=element_blank())
```

We can see that survival function is rapidly approach 0, meaning that the probability of living longer than $t>2$ is virtually zero. However, we also note that the hazard function is flat at $h(t)=2$. This is note a coincidence, as the exponential function is known to give a constant hazard function, meaning that given you have made it to some point $t_1$ the probablity of mortality in the next moment is going to be the same as someone who made it to $t_2$, which is another way of saying the exponential distribution is [memoryless](https://en.wikipedia.org/wiki/Memorylessness).

As a constant hazard rate is a strong modelling assumption, alternative distributions for the duration measure are often used in the literature including the [Weibull distribution](https://en.wikipedia.org/wiki/Weibull_distribution) which permits an increasing, descreasing, or constant hazard rate depending on $\alpha$:

*$T \sim$ Weibull distribution$
1. $F(t\|\theta,\alpha)=1-\exp[-(\theta t)^\alpha]$
2. $S(t\|\theta,\alpha)=\exp[-(\theta t)^\alpha]$
3. $h(t)=\alpha\theta^\alpha t^{\alpha-1}$

Let's see how the Weibull hazard function looks for different parameterizations of $\alpha$ with $\theta=1$.

```{r weibull_param,echo=F,fig.width=2.0,fig.height=2.0}
h.weibull <- function(t,alpha,theta=1) { alpha*(theta^alpha)*t^(alpha-1) }
# Make the text mapping
tmap <- data.frame(x=c(2,2,0.75),y=c(3,1.5,2.5),lab=c("alpha*'=1.5'","alpha*'=1'","alpha*'=1/2'"))
cmap <- c("#F8766D","#00BA38","#619CFF")

ggplot(data.frame(t=seq(0.01,5,0.1)),aes(x=t)) + theme_cowplot(font_size=10) +
  stat_function(fun=h.weibull,args=list(alpha=1.5),color=cmap[2],size=1) + 
  stat_function(fun=h.weibull,args=list(alpha=1.0),color=cmap[1],size=1) + 
  stat_function(fun=h.weibull,args=list(alpha=0.5),color=cmap[3],size=1) + 
  labs(x='Time') + theme(axis.title.y=element_blank()) + 
  geom_text(data=tmap,aes(x=x,y=y,label=lab,color=lab),inherit.aes=F,parse=T,show.legend=F,size=2.5) + 
  ggtitle('Weibull hazard function')

```

## A distribution with covariates

<!-- Now we're ready to simulate some data and estimate the parameters with maximum likelihood. We'll use a Weibull($\theta=1,\alpha=1.5$) distribution to generate $i=15$ observations and find the set of parameters which maximizes the log-likelihood: -->

<!-- $l(t|\theta,\alpha)=\sum_{i=1}^15 \log h(t_i|\$  -->

* * *

[^1]: That is, if there were two datasets of survival times, with patient cohorts of breast and pancreatic cancer, respectively, then we would expect that probability of survival would be lower in the latter group, even with the same covariates, simply because pancreatic cancer is known to be a more aggressive cancer.

